var globals={chat:{lastReceived:0,updID:0,sendUrl:"",updateUrl:""},game:{lastChange:0,running:false,url:"",chkID:0,updID:0},time:new Date(),stopPositionUpdate:false,updatingGame:false,user:{id:0,name:"",isOne:false}};function init(){$("#writemessage").keypress(sendMessage);$("#menu-slider").click(menuSlide);$("#menu-header").click(menuSlide);$("#opponent-loader").show();pack();checkGameStart();setTimeout(updateMessages,1000)}function checkGameStart(){$.ajax({url:globals.game.url,data:{event:"startGame"},type:"POST",dataType:"json",success:function(a){if(a.result=="ok"){$("#opponent-loader").hide();$("#game-loader").show();$.ajax({url:globals.game.url,data:{event:"startUp"},type:"POST",dataType:"json",success:function(n){if(n.result=="ok"){var k=n.createThis,g=new Array(),h=new Array(),f,j,c,e,m,d,l=$("#decks"),b,o;$(n.gameInfo.tokens).each(function(p,q){g.push({option:q.name,event:function(i){toggleCardToken($(i).attr("id"),q.id)}})});$(n.gameInfo.cardStates).each(function(p,q){h.push({option:q.name,event:function(i){toggleCardState($(i).attr("id"),q.id)}})});$(document.createElement("div")).attr({id:k.nowhere.id}).css({visibility:"hidden",position:"absolute",top:-200,left:-200}).appendTo($("body"));$(".hand").attr("id",k.player.hand.id);$(".play").attr("id",k.player.playableArea.id);d=k.player.decks;for(j=0;j<d.length;j++){c=d[j].id;e=$(document.createElement("div")).addClass("deck-info-left");m=$(document.createElement("div")).addClass("deck-info-right");$(document.createElement("a")).attr("href","javascript:;").click(function(i){drawCard(c)}).html("Draw to Hand").appendTo(e);e.append("<br />");$(document.createElement("a")).attr("href","javascript:;").click(function(i){drawCardToTable(c)}).html("Draw to Table").appendTo(e);e.append("<br />");$(document.createElement("a")).attr("href","javascript:;").click(function(i){shuffleDeck(c)}).html("Shuffle").appendTo(e);e.append("<br />");$(document.createElement("img")).attr({id:d[j].id,src:"_game/cards/thumbs/cardback.jpg"}).appendTo(m);$(document.createElement("div")).addClass("deck-info").append("<h3>"+d[j].name+"</h3>").append(e).append(m).appendTo(l);l.append('<div class="clearfix"></div>')}if(k.player.graveyard){e=$(document.createElement("div")).addClass("deck-info-left");m=$(document.createElement("div")).addClass("deck-info-right");$(document.createElement("a")).attr("href","javascript:;").click(drawFromGraveyard).html("Draw to Hand").appendTo(e);e.append("<br />");$(document.createElement("a")).attr("href","javascript:;").click(drawFromGraveyardToTable).html("Draw to Table").appendTo(e);e.append("<br />");$(document.createElement("a")).attr("href","javascript:;").click(shuffleGraveyard).html("Shuffle").appendTo(e);e.append("<br />");$(document.createElement("img")).attr({id:k.player.graveyard.id,src:"_game/cards/thumbs/noimage.jpg"}).appendTo(m);$(document.createElement("div")).addClass("deck-info").append("<h3>Graveyard</h3>").append(e).append(m).appendTo(l);l.append('<div class="clearfix"></div>')}$(".opponent-area").attr("id",k.opponent.playableArea.id);for(j=0;j<k.cards.length;j++){f=k.cards[j];$(document.createElement("div")).html('<img class="face" />').attr({id:f.id}).addClass("card").draggable({stack:".card",revert:"invalid"}).append($(document.createElement("div")).addClass("label")).appendTo($("body"))}o=(k.player.graveyard!=null);for(j=0;j<k.cards.length;j++){f=k.cards[j];b=[{option:'<img src="_resources/images/icon-x16-eye.png" title="Card Details" />',event:function(i){requestCardInfo($(i).attr("id"))}},{option:'<img src="_resources/images/icon-x16-bookmarks.png" title="Tokens" />',subMenu:g},{option:'<img src="_resources/images/icon-x16-hand-state.png" title="States" />',subMenu:h},{option:'<img src="_resources/images/icon-x16-flip" title="Flip Card" />',event:function(i){flipCard($(i).attr("id"))}},{option:'<img src="_resources/images/icon-x16-label.png" title="Custom Label" />',event:function(i){$("#label-text").val($(i).find(".label").html());$("#label-card-id").val($(i).attr("id"));$("#label-dlg").modal()}},{option:'<img src="_resources/images/icon-x16-cardinal.png" title="Counters" />',event:function(i){$("#counter-card-id").val($(i).attr("id"));$("#counter-dlg").modal()}}];if(o){b.push({option:'<img src="_resources/images/icon-x16-headstone.png" title="Send to Graveyard" />',event:function(i){moveToGraveyard($(i).attr("id"))}})}$("#"+f.id).css({position:"absolute",visibility:f.visibility}).css({top:350,left:-250}).data("status",f).addClass("update").radialmenu({radius:60,options:b}).children("img.face").attr("src","_game/cards/thumbs/"+(f.invertView?"reversed/":"")+f.src);updateCardExtras($("#"+f.id))}$(".card").droppable({drop:function(i,p){moveCard(p.draggable.attr("id"),$(this).attr("id"),0,0.2);return false}});$(".play, .hand").droppable({drop:function(r,s){var i=s.draggable,p,t,q=$(this);p=(i.offset().left-q.offset().left)/q.width();t=(i.offset().top-q.offset().top)/q.height();moveCard(i.attr("id"),q.attr("id"),p,t);return false}});globals.game.running=true;cyclicPositionUpdate();$("#game-loader").fadeOut("slow",function(){$("#game-loader").remove()})}}})}else{}},error:function(){}})}function updateCardExtras(a){if(a.data("status")){var b,c=a.data("status");a.find(".token").remove();for(b=0;b<c.tokens.length;++b){$(document.createElement("img")).addClass("token").attr("src","_game/tokens/thumbs/"+(c.invertView?"reversed/":"")+c.tokens[b].src).appendTo(a)}a.find(".state").remove();for(b=0;b<c.states.length;++b){$(document.createElement("img")).addClass("state").attr("src","_game/states/thumbs/"+(c.invertView?"reversed/":"")+c.states[b].src).appendTo(a)}a.find(".counter").remove();for(b=0;b<c.counters.length;++b){placeCounter(a,c.counters[b].id,c.counters[b].value,c.counters[b].name,c.counters[b].color,b*20)}a.find(".label").css("display",a.data("status").label?"":"none").html(a.data("status").label)}}function cyclicPositionUpdate(){if(!globals.stopPositionUpdate){$(".update").each(function(b,f){f=$(f);if(f.data("status")&&!f.hasClass("ui-draggable-dragging")&&!f.is(":animated")&&f.data("status").visibility=="visible"){var c=f.data("status"),a=$("#"+c.location),e,d;if(!f.data("status").invertView){e=a.offset().top+Math.round(c.yOffset*a.height());d=a.offset().left+Math.round(c.xOffset*a.width())}else{e=a.offset().top+Math.round((1-f.data("status").yOffset)*a.height())-f.height();d=a.offset().left+Math.round((1-f.data("status").xOffset)*a.width())-f.width()}f.animate({top:e+"px",left:d+"px"},500);if($(".ui-draggable-dragging").length==0){f.css({zIndex:f.data("status").zIndex})}}})}setTimeout(cyclicPositionUpdate,300)}function doGameUpdate(b){if(b.result=="ok"&&parseInt(b.clientTime)==globals.time.getTime()){if(b.lastChange){globals.game.lastChange=b.lastChange}for(var a=0;a<b.update.length;a++){$("#"+b.update[a].id).data("status",b.update[a]);if(!$("#"+b.update[a].id).hasClass("update")){$("#"+b.update[a].id).addClass("movable")}$("#"+b.update[a].id).css({zIndex:b.update[a].zIndex,visibility:b.update[a].visibility}).children("img.face").attr("src","_game/cards/thumbs/"+(b.update[a].invertView?"reversed/":"")+b.update[a].src);updateCardExtras($("#"+b.update[a].id))}}globals.updatingGame=false}function updateGame(){globals.time=new Date();if(!globals.updatingGame&&parseInt($.active)==0&&$(".ui-draggable-dragging").length==0){globals.updatingGame=true;$.ajax({url:globals.game.url,data:{event:"update",clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){setTimeout(updateGame,3000)}})}else{setTimeout(updateGame,3000)}}function toggleCardToken(a,b){globals.updatingGame=true;globals.time=new Date();if($(".ui-draggable-dragging").length==0){$.ajax({url:globals.game.url,data:{event:"toggleCardToken",card:a,token:b,clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate})}}function toggleCardState(a,b){globals.updatingGame=true;globals.time=new Date();if($(".ui-draggable-dragging").length==0){$.ajax({url:globals.game.url,data:{event:"toggleCardState",card:a,state:b,clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate})}}function drawCard(a){globals.updatingGame=true;globals.stopPositionUpdate=true;globals.time=new Date();$.ajax({url:globals.game.url,data:{event:"drawCard",deck:a,clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){globals.stopPositionUpdate=false}})}function moveCard(b,d,a,c){globals.updatingGame=true;globals.stopPositionUpdate=true;globals.time=new Date();$.ajax({url:globals.game.url,data:{event:"moveCard",card:b,location:d,xOffset:a,yOffset:c,clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){globals.stopPositionUpdate=false}})}function requestCardInfo(a){$.ajax({url:globals.game.url,data:{event:"cardInfo",card:a},type:"POST",dataType:"json",success:function(d){$("#card-info .temp").remove();if(d.success){var b=$("#card-info"),c;$("#card-image").attr("src","_game/cards/"+d.status.src);for(c=0;c<d.status.tokens.length;c++){$(document.createElement("img")).addClass("temp").css("z-index",1).attr("src","_game/tokens/"+d.status.tokens[c].src).appendTo(b)}for(c=0;c<d.status.states.length;c++){$(document.createElement("img")).addClass("temp").css("z-index",-1).attr("src","_game/states/"+d.status.states[c].src).appendTo(b)}for(c=0;c<d.status.counters.length;++c){$(document.createElement("span")).attr("id",d.status.counters[c].id).addClass("temp").addClass(d.status.counters[c].color).text(d.status.counters[c].value)}b.find(".big-label").css("display",d.status.label?"":"none").html(d.status.label)}else{$("#card-image").attr("src","_game/cards/cardback.jpg")}}})}function pack(){$("#left-column").css({height:$(window).height(),top:0,left:0,position:"absolute"});$(".hand").css({height:$(window).height()-543});$(".opponent-area").css({width:$(window).width()-270,height:$(window).height()/2,top:0,left:270,position:"absolute"});$(".play").css({width:$(window).width()-270,height:$(window).height()/2,top:$(window).height()/2,left:270,position:"absolute"})}function sendMessage(c){if(c.keyCode==13){var b=$("#writemessage").val(),a;if(b.length>0){$.ajax({type:"POST",url:globals.chat.sendUrl,data:{gamemessage:b},dataType:"json",success:function(d){if(d.success){$("#chat-messages").append('<li class="user-message '+(d.order==1?"player1-text":(d.order==2?"player-text":"spectator-text"))+'"><strong>'+d.date+"</strong>: "+d.message+"</li>");globals.chat.lastReceived=d.id;chatToBottom()}}});$("#writemessage").val("")}}}function updateMessages(){$.ajax({type:"POST",url:globals.chat.updateUrl,data:{lastupdate:globals.chat.lastReceived},dataType:"json",success:function(b){if(b.has){var a=$("#chat-messages");$.each(b.messages,function(){a.append('<li class="'+(this.system?"system-message ":"user-message ")+(this.order==1?"player1-text":(this.order==2?"player-text":"spectator-text"))+'"><strong>'+this.date+"</strong>: "+this.message+"</li>")});globals.chat.lastReceived=b.last;chatToBottom()}},complete:function(){setTimeout(updateMessages,5000)}})}function sliderSetValue(a,b){chatToBottom()}function chatToBottom(){var b=$("#chat-slider"),a=$("#chat-messages"),c=a.height(),d=-(c-130);if(c>130){b.slider("option","min",d).slider("option","value",d);a.animate({top:d},"slow")}}function filterChatMessages(){var b=$("#show-user-messages"),a=$("#show-system-messages");if(b.is(":checked")){console.log(("li.user-message").length);$("li.user-message").show()}else{console.log(("li.user-message").length);$("li.user-message").hide()}if(a.is(":checked")){console.log(("li.system-message").length);$("li.system-message").show()}else{console.log(("li.system-message").length);$("li.system-message").hide()}chatToBottom()}function roll(a){$.ajax({url:globals.game.url,data:{event:"roll",dice:a},type:"POST",dataType:"json",success:function(b){if(b.success){$.jGrowl(b.dice+" rolled for (1 - "+b.face+"): "+b.roll)}}})}function sliderChange(b,a){$("#chat-messages").css({top:a.value})}function sliderScroll(b,a){$("#chat-messages").css({top:a.value})}function flipCard(a){$.ajax({url:globals.game.url,data:{event:"flipCard",card:a},type:"POST",dataType:"json",success:function(b){if(b.success){$("#"+a).attr("src","_game/cards/thumbs/"+(b.status.invertView?"reversed/":"")+b.status.src)}}})}function shuffleDeck(a){$.ajax({url:globals.game.url,data:{event:"shuffleDeck",deck:a},dataType:"json",type:"POST",success:function(b){$.jGrowl("Deck shuffled.")}})}function drawCardToTable(a){globals.updatingGame=true;globals.stopPositionUpdate=true;globals.time=new Date();$.ajax({url:globals.game.url,data:{event:"drawCardToTable",deck:a,clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){globals.stopPositionUpdate=false}})}function menuSlide(){if(globals.game.running){var a=$("#menu-wrapper");if(a.width()>0){a.animate({width:0});$("#menu-slider").animate({right:0})}else{a.animate({width:250});$("#menu-slider").animate({right:250})}}}function setLabel(){globals.updatingGame=true;globals.stopPositionUpdate=true;globals.time=new Date();$.ajax({url:globals.game.url,data:{event:"label",card:$("#label-card-id").val(),label:$("#label-text").val(),clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){globals.stopPositionUpdate=false}})}function moveToGraveyard(a){globals.updatingGame=true;globals.stopPositionUpdate=true;globals.time=new Date();$.ajax({url:globals.game.url,data:{event:"toGraveyard",card:a,clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){globals.stopPositionUpdate=false}})}function drawFromGraveyard(){globals.updatingGame=true;globals.stopPositionUpdate=true;globals.time=new Date();$.ajax({url:globals.game.url,data:{event:"fromGraveyard",clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){globals.stopPositionUpdate=false}})}function drawFromGraveyardToTable(){globals.updatingGame=true;globals.stopPositionUpdate=true;globals.time=new Date();$.ajax({url:globals.game.url,data:{event:"fromGraveyardToTable",clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){globals.stopPositionUpdate=false}})}function shuffleGraveyard(){$.ajax({url:globals.game.url,data:{event:"shuffleGraveyard"},dataType:"json",type:"POST",success:function(a){$.jGrowl("Graveyard shuffled.")}})}function addCounter(){var b=$("#counter-card-id").val(),a=$("#"+b);$.ajax({url:globals.game.url,data:{event:"addCounter",clientTime:globals.time.getTime(),card:b,name:$("#counter-name").val(),start:$("#counter-value").val(),step:$("#counter-step").val(),color:$("#counter-class").val()},dataType:"json",type:"POST",success:function(d){if(d.success){var c=d.counter;placeCounter(a,c.id,c.value,c.name,c.color,(d.count-1)*20)}}})}function placeCounter(c,e,d,b,a,f){$(document.createElement("div")).attr({id:e,title:b}).addClass("counter").addClass("counter-widget").css("top",f).append($(document.createElement("div")).addClass("counter-text").addClass(a).text(d)).append($(document.createElement("div")).addClass("counter-tools").append($(document.createElement("img")).attr("src","_resources/images/icon-x16-plus.png").data("counter",b).data("counterId",e).data("card",c.attr("id")).click(increaseCounter)).append($(document.createElement("img")).attr("src","_resources/images/icon-x16-minus.png").data("counter",b).data("counterId",e).data("card",c.attr("id")).click(decreaseCounter))).appendTo(c)}function increaseCounter(b){var a=$(this);$.ajax({url:globals.game.url,data:{event:"increaseCounter",card:a.data("card"),counter:a.data("counter")},dataType:"json",type:"POST",success:function(c){if(c.success){$("#"+a.data("counterId")+" .counter-text").text(c.value)}}});return false}function decreaseCounter(b){var a=$(this);$.ajax({url:globals.game.url,data:{event:"decreaseCounter",card:a.data("card"),counter:a.data("counter")},dataType:"json",type:"POST",success:function(c){if(c.success){$("#"+a.data("counterId")+" .counter-text").text(c.value)}}});return false};