var globals={chat:{lastReceived:0,updID:0,sendUrl:"",updateUrl:""},game:{lastChange:0,running:false,url:"",chkID:0,updID:0},time:new Date(),stopPositionUpdate:false,updatingGame:false,user:{id:0,name:"",isOne:false}};function init(){$("#writemessage").keypress(sendMessage);$("#menu-slider").click(menuSlide);$("#menu-header").click(menuSlide);$("#opponent-loader").show();pack();checkGameStart();setTimeout(updateMessages,1000)}function checkGameStart(){$.ajax({url:globals.game.url,data:{event:"startGame"},type:"POST",dataType:"json",success:function(a){if(a.result=="ok"){$("#opponent-loader").hide();$("#game-loader").show();$.ajax({url:globals.game.url,data:{event:"startUp"},type:"POST",dataType:"json",success:function(e){if(e.result=="ok"){var d=e.createThis,b,c,f;$(".hand").attr("id",d.player.hand.id);$(".play").attr("id",d.player.playableArea.id);$(".opponent-area").attr("id",d.opponent.playableArea.id);for(c=0;c<d.cards.length;c++){b=d.cards[c];$(document.createElement("div")).html('<img class="face" />').attr({id:b.id}).addClass("card").draggable({stack:".card",revert:"invalid"}).append($(document.createElement("div")).addClass("label")).appendTo($("body"))}for(c=0;c<d.cards.length;c++){b=d.cards[c];f=[{option:'<img src="_resources/images/icon-x16-eye.png" title="Card Details" />',event:function(g){requestCardInfo($(g).attr("id"))}}];$("#"+b.id).css({position:"absolute",visibility:b.visibility}).css({top:350,left:-250}).data("status",b).addClass("update").radialmenu({radius:60,options:f}).children("img.face").attr("src","_game/cards/thumbs/"+(b.invertView?"reversed/":"")+b.src);updateCardExtras($("#"+b.id))}$(".card").droppable({drop:function(g,h){moveCard(h.draggable.attr("id"),$(this).attr("id"),0,0.2);return false}});$(".play, .hand").droppable({drop:function(j,k){var g=k.draggable,h,l,i=$(this);h=(g.offset().left-i.offset().left)/i.width();l=(g.offset().top-i.offset().top)/i.height();moveCard(g.attr("id"),i.attr("id"),h,l);return false}});globals.game.running=true;setTimeout(updateGame,3000);cyclicPositionUpdate();$("#game-loader").fadeOut("slow",function(){$("#game-loader").remove()})}}})}else{setTimeout(checkGameStart,3000)}},error:function(){setTimeout(checkGameStart,3000)}})}function cyclicPositionUpdate(){if(!globals.stopPositionUpdate){$(".update").each(function(b,f){f=$(f);if(f.data("status")&&!f.hasClass("ui-draggable-dragging")&&!f.is(":animated")&&f.data("status").visibility=="visible"){var c=f.data("status"),a=$("#"+c.location),e,d;if(!f.data("status").invertView){e=a.offset().top+Math.round(c.yOffset*a.height());d=a.offset().left+Math.round(c.xOffset*a.width())}else{e=a.offset().top+Math.round((1-f.data("status").yOffset)*a.height())-f.height();d=a.offset().left+Math.round((1-f.data("status").xOffset)*a.width())-f.width()}f.animate({top:e+"px",left:d+"px"},500);if($(".ui-draggable-dragging").length==0){f.css({zIndex:f.data("status").zIndex})}}})}setTimeout(cyclicPositionUpdate,300)}function doGameUpdate(b){if(b.result=="ok"&&parseInt(b.clientTime)==globals.time.getTime()){if(b.lastChange){globals.game.lastChange=b.lastChange}for(var a=0;a<b.update.length;a++){$("#"+b.update[a].id).data("status",b.update[a]);if(!$("#"+b.update[a].id).hasClass("update")){$("#"+b.update[a].id).addClass("movable")}$("#"+b.update[a].id).css({zIndex:b.update[a].zIndex,visibility:b.update[a].visibility}).children("img.face").attr("src","_game/cards/thumbs/"+(b.update[a].invertView?"reversed/":"")+b.update[a].src);updateCardExtras($("#"+b.update[a].id))}}globals.updatingGame=false}function updateGame(){globals.time=new Date();if(!globals.updatingGame&&parseInt($.active)==0&&$(".ui-draggable-dragging").length==0){globals.updatingGame=true;$.ajax({url:globals.game.url,data:{event:"update",clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){setTimeout(updateGame,3000)}})}else{setTimeout(updateGame,3000)}}function moveCard(b,d,a,c){globals.updatingGame=true;globals.stopPositionUpdate=true;globals.time=new Date();$.ajax({url:globals.game.url,data:{event:"moveCard",card:b,location:d,xOffset:a,yOffset:c,clientTime:globals.time.getTime()},dataType:"json",type:"POST",success:doGameUpdate,complete:function(){globals.stopPositionUpdate=false}})}function requestCardInfo(a){$.ajax({url:globals.game.url,data:{event:"cardInfo",card:a},type:"POST",dataType:"json",success:function(d){$("#card-info .temp").remove();if(d.success){var b=$("#card-info"),c;$("#card-image").attr("src","_game/cards/"+d.status.src);for(c=0;c<d.status.tokens.length;c++){$(document.createElement("img")).addClass("temp").css("z-index",1).attr("src","_game/tokens/"+d.status.tokens[c].src).appendTo(b)}for(c=0;c<d.status.states.length;c++){$(document.createElement("img")).addClass("temp").css("z-index",-1).attr("src","_game/states/"+d.status.states[c].src).appendTo(b)}for(c=0;c<d.status.counters.length;++c){$(document.createElement("span")).attr("id",d.status.counters[c].id).addClass("temp").addClass(d.status.counters[c].color).text(d.status.counters[c].value)}b.find(".big-label").css("display",d.status.label?"":"none").html(d.status.label)}else{$("#card-image").attr("src","_game/cards/cardback.jpg")}}})}function pack(){}function sendMessage(c){if(c.keyCode==13){var b=$("#writemessage").val(),a;if(b.length>0){$.ajax({type:"POST",url:globals.chat.sendUrl,data:{gamemessage:b},dataType:"json",success:function(d){if(d.success){$("#chat-messages").append('<li class="user-message '+(d.order==1?"player1-text":(d.order==2?"player-text":"spectator-text"))+'"><strong>'+d.date+"</strong>: "+d.message+"</li>");globals.chat.lastReceived=d.id;chatToBottom()}}});$("#writemessage").val("")}}}function updateMessages(){$.ajax({type:"POST",url:globals.chat.updateUrl,data:{lastupdate:globals.chat.lastReceived},dataType:"json",success:function(b){if(b.has){var a=$("#chat-messages");$.each(b.messages,function(){a.append('<li class="'+(this.system?"system-message ":"user-message ")+(this.order==1?"player1-text":(this.order==2?"player-text":"spectator-text"))+'"><strong>'+this.date+"</strong>: "+this.message+"</li>")});globals.chat.lastReceived=b.last;chatToBottom()}},complete:function(){setTimeout(updateMessages,5000)}})}function sliderSetValue(a,b){chatToBottom()}function chatToBottom(){var b=$("#chat-slider"),a=$("#chat-messages"),c=a.height(),d=-(c-130);if(c>130){b.slider("option","min",d).slider("option","value",d);a.animate({top:d},"slow")}}function filterChatMessages(){var b=$("#show-user-messages"),a=$("#show-system-messages");if(b.is(":checked")){console.log(("li.user-message").length);$("li.user-message").show()}else{console.log(("li.user-message").length);$("li.user-message").hide()}if(a.is(":checked")){console.log(("li.system-message").length);$("li.system-message").show()}else{console.log(("li.system-message").length);$("li.system-message").hide()}chatToBottom()}function sliderChange(b,a){$("#chat-messages").css({top:a.value})}function sliderScroll(b,a){$("#chat-messages").css({top:a.value})}function flipCard(a){$.ajax({url:globals.game.url,data:{event:"flipCard",card:a},type:"POST",dataType:"json",success:function(b){if(b.success){$("#"+a).attr("src","_game/cards/thumbs/"+(b.status.invertView?"reversed/":"")+b.status.src)}}})}function menuSlide(){if(globals.game.running){var a=$("#menu-wrapper");if(a.width()>0){a.animate({width:0});$("#menu-slider").animate({right:0})}else{a.animate({width:250});$("#menu-slider").animate({right:250})}}};